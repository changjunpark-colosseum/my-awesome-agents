name: CGKR Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1 # ë¦¬ë·°ë¥¼ ìœ„í•´ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

      - name: Delete Previous Claude Reviews
        if: github.event.action == 'synchronize'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e  # Continue on error
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          echo "ğŸ” ì´ì „ Claude ë¦¬ë·° ê²€ìƒ‰ ì¤‘..."

          # github-actions[bot]ì´ ì‘ì„±í•œ ì½”ë©˜íŠ¸ë§Œ ì‚­ì œ (ì¼ë°˜ ì‚¬ìš©ì ì½”ë©˜íŠ¸ ë³´í˜¸)
          gh api "repos/$REPO/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]") | .id' \
            | while read comment_id; do
                if [ -n "$comment_id" ]; then
                  echo "ğŸ—‘ï¸  PR ì½”ë©˜íŠ¸ ì‚­ì œ: $comment_id"
                  gh api -X DELETE "repos/$REPO/issues/comments/$comment_id" 2>/dev/null || echo "âš ï¸  ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ)"
                fi
              done

          # ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ ì²˜ë¦¬
          # ë´‡ì´ ì‘ì„±í•œ ìŠ¤ë ˆë“œ ì¤‘ í•´ê²°ë˜ì§€ ì•Šì€ ê²ƒë§Œ ì‚­ì œ
          OWNER=${REPO%/*}
          NAME=${REPO#*/}

          # GitHub GraphQL APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ë·° ìŠ¤ë ˆë“œ ì¡°íšŒ
          gh api graphql -F owner="$OWNER" -F name="$NAME" -F number=$PR_NUMBER -f query='
            query($owner: String!, $name: String!, $number: Int!) {
              repository(owner: $owner, name: $name) {
                pullRequest(number: $number) {
                  reviewThreads(last: 100) {
                    nodes {
                      isResolved
                      comments(first: 1) {
                        nodes {
                          databaseId
                          author {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              }
            }' \
            --jq '.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false) | select(.comments.nodes[0].author.login == "github-actions") | .comments.nodes[0].databaseId' \
            | while read comment_id; do
                if [ -n "$comment_id" ]; then
                  echo "ğŸ—‘ï¸  ì¸ë¼ì¸ ì½”ë©˜íŠ¸ ì‚­ì œ: $comment_id"
                  gh api -X DELETE "repos/$REPO/pulls/comments/$comment_id" 2>/dev/null || echo "âš ï¸  ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ)"
                fi
              done
          echo "âœ… ì´ì „ ë¦¬ë·° ì‚­ì œ ì™„ë£Œ"

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: "https://github.com/anthropics/claude-code.git"
          plugins: "code-review@claude-code-plugins"
          # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ëŒ€ì‹  ìì—°ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ì´ PR(#${{ github.event.pull_request.number }})ì— ëŒ€í•´ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.
            ì„¤ì¹˜ëœ code-review í”ŒëŸ¬ê·¸ì¸ì˜ ê¸°ëŠ¥ì„ í™œìš©í•˜ê±°ë‚˜, ì§ì ‘ ë³€ê²½ ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í•­ëª©ì„ ì¤‘ì ì ìœ¼ë¡œ ë´ì£¼ì„¸ìš”:

            1. ì ì¬ì ì¸ ë²„ê·¸
            2. ì½”ë“œ í’ˆì§ˆ ë° ìŠ¤íƒ€ì¼
            3. ë³´ì•ˆ ì·¨ì•½ì 

            ë¦¬ë·° ê²°ê³¼ëŠ” GitHub PR ì½”ë©˜íŠ¸ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.

          # 2. ë„êµ¬ í—ˆìš©: ì¸ë¼ì¸ ì½”ë©˜íŠ¸ ìƒì„± íˆ´(mcp__github_inline_comment__create_inline_comment)ì„ ëª…ì‹œ
          claude_args: '--allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr view:*),Bash(gh pr diff:*)"'
